# (c) Copyright IBM Corp. 2020,2021
# Apache License, Version 2.0 (see https://opensource.org/licenses/Apache-2.0)
---
- name:  CMCI HTTP Integration Test
  collections:
   - ibm.ibm_zos_cics
  hosts: 'localhost'
  gather_facts: false
  vars:
    csdgroup: 'HTTPTEST'
    program: 'HTTPTEST'
    program_2: 'HTTPTES2'
    program_filter: 'HTTPTES*'

  module_defaults:
    ibm.ibm_zos_cics.cmci_get:
      cmci_host: '{{ cmci_host }}'
      cmci_port: '{{ cmci_port }}'
      cmci_user: '{{ cmci_user }}'
      cmci_password: '{{ cmci_password }}'
      context: '{{ cmci_context }}'
      scope: '{{ cmci_scope_http }}'
      insecure: true
      scheme: 'http'


    ibm.ibm_zos_cics.cmci_update:
      cmci_host: '{{ cmci_host }}'
      cmci_port: '{{ cmci_port }}'
      cmci_user: '{{ cmci_user }}'
      cmci_password: '{{ cmci_password }}'
      context: '{{ cmci_context }}'
      scope: '{{ cmci_scope_http }}'
      insecure: true
      scheme: 'http'


    ibm.ibm_zos_cics.cmci_delete:
      cmci_host: '{{ cmci_host }}'
      cmci_port: '{{ cmci_port }}'
      cmci_user: '{{ cmci_user }}'
      cmci_password: '{{ cmci_password }}'
      context: '{{ cmci_context }}'
      scope: '{{ cmci_scope_http }}'
      insecure: true
      scheme: 'http'


    ibm.ibm_zos_cics.cmci_action:
      cmci_host: '{{ cmci_host }}'
      cmci_port: '{{ cmci_port }}'
      cmci_user: '{{ cmci_user }}'
      cmci_password: '{{ cmci_password }}'
      context: '{{ cmci_context }}'
      scope: '{{ cmci_scope_http }}'
      insecure: true
      scheme: 'http'


    ibm.ibm_zos_cics.cmci_create:
      cmci_host: '{{ cmci_host }}'
      cmci_port: '{{ cmci_port }}'
      cmci_user: '{{ cmci_user }}'
      cmci_password: '{{ cmci_password }}'
      context: '{{ cmci_context }}'
      scope: '{{ cmci_scope_http }}'
      insecure: true
      scheme: 'http'

  tasks:
    - name: 'HTTP Delete progdef'
      delegate_to: 'localhost'
      ibm.ibm_zos_cics.cmci_delete:
        type: 'CICSDefinitionProgram'
        resources:
          complex_filter:
            and:
              - attribute: NAME
                value: '{{ program }}'
              - attribute: CSDGROUP
                value: '{{ csdgroup }}'
          get_parameters:
            - name: 'CSDGROUP'
              value: '{{ csdgroup }}'
      register: result
      failed_when: >
        'cpsm_response' not in result or result.cpsm_response not in ['OK', 'NODATA']


    - name: 'HTTP Create progdef'
      delegate_to: 'localhost'
      ibm.ibm_zos_cics.cmci_create:
        type: 'CICSDefinitionProgram'
        attributes:
          name: '{{ program }}'
          csdgroup: '{{ csdgroup }}'
        create_parameters:
          - name: 'CSD'
      register: result

    - name: assert 1
      assert:
        that:
          - result is changed
          - result.cpsm_response == 'OK'
          - result.record_count == 1
          - result.records[0].name == program


    - name: 'HTTP Update progdef'
      delegate_to: 'localhost'
      ibm.ibm_zos_cics.cmci_update:
        type: 'CICSDefinitionProgram'
        attributes:
          description: 'foo'
        resources:
          filter:
            NAME: '{{ program }}'
          get_parameters:
            - name: 'CSDGROUP'
              value: '{{ csdgroup }}'
      register: result

    - name: assert 2
      assert:
        that:
          - result is changed
          - result.cpsm_response == 'OK'
          - result.record_count == 1
          - result.records[0].description == 'foo'


    - name: 'HTTP Install program'
      delegate_to: 'localhost'
      ibm.ibm_zos_cics.cmci_action:
        type: 'CICSDefinitionProgram'
        action_name: 'CSDINSTALL'
        resources:
          filter:
            NAME: '{{ program }}'
          get_parameters:
            - name: 'CSDGROUP'
              value: '{{ csdgroup }}'
      register: result

    - name: assert 3
      assert:
        that:
          - result is changed
          - result.cpsm_response == 'OK'
          - result.record_count == 1


    - name: 'HTTP Check program was installed'
      delegate_to: 'localhost'
      ibm.ibm_zos_cics.cmci_get:
        type: 'CICSProgram'
        resources:
          filter:
            PROGRAM: '{{ program }}'
      retries: 3  # May take a while to install, so give it a chance!
      until: result is not failed
      register: result

    - name: assert 4
      assert:
        that:
          - result is not changed
          - result.cpsm_response == 'OK'
          - result.record_count == 1
          - result.records[0].program == program


    - name: 'HTTP Disable program'
      delegate_to: 'localhost'
      ibm.ibm_zos_cics.cmci_update:
        type: 'CICSProgram'
        attributes:
          status: 'disabled'
        resources:
          filter:
            PROGRAM: '{{ program }}'
          complex_filter:
            and:
              - attribute: 'PROGRAM'
                operator: '='
                value: '{{ program }}'
              - or:
                  - attribute: 'USECOUNT'
                    operator: '!='
                    value: '0'
                  - attribute: 'USECOUNT'
                    operator: 'LT'
                    value: '1'
      register: result

    - name: assert 5
      assert:
        that:
          - result is changed
          - result.cpsm_response == 'OK'
          - result.record_count == 1
          - result.records[0].program == program
          - result.records[0].status == 'DISABLED'


    - name: 'HTTP Delete program'
      delegate_to: 'localhost'
      ibm.ibm_zos_cics.cmci_delete:
        type: 'CICSProgram'
        resources:
          filter:
            PROGRAM: '{{ program }}'
      register: result

    - name: assert 6
      assert:
        that:
          - result is changed
          - result.cpsm_response == 'OK'
          - result.record_count == 1
          - result.success_count == 1
    

    - name: 'HTTP Create progdef 2'
      delegate_to: 'localhost'
      ibm.ibm_zos_cics.cmci_create:
        type: 'CICSDefinitionProgram'
        attributes:
          name: '{{ program_2 }}'
          csdgroup: '{{ csdgroup }}'
        create_parameters:
          - name: 'CSD'
      register: result

    - name: assert program_2 created
      assert:
        that:
          - result is changed
          - result.cpsm_response == 'OK'
          - result.record_count == 1
          - result.records[0].name == program_2

    
    - name: 'HTTP Check All Records Returned'
      delegate_to: 'localhost'
      ibm.ibm_zos_cics.cmci_get:
        type: 'CICSDefinitionProgram'
        resources:
          filter:
            name: '{{ program_filter }}'
          get_parameters:
            - name: 'CSDGROUP'
              value: '{{ csdgroup }}'
      register: result

    - name: assert record_count is 2
      assert:
        that:
          - result is not changed
          - result.cpsm_response == 'OK'
          - result.record_count == 2
    

    - name: 'HTTP Check record count attribute'
      delegate_to: 'localhost'
      ibm.ibm_zos_cics.cmci_get:
        type: 'CICSDefinitionProgram'
        record_count: 1
        resources:
          filter:
            name: '{{ program_filter }}'
          get_parameters:
            - name: 'CSDGROUP'
              value: '{{ csdgroup }}'
      register: result
    
    - name: assert record_count attribute
      assert:
        that:
          - result is not changed
          - result.cpsm_response == 'OK'
          - result.record_count == 2
          - result.records|length == 1


    - name: 'HTTP Delete progdef'
      delegate_to: 'localhost'
      ibm.ibm_zos_cics.cmci_delete:
        type: 'CICSDefinitionProgram'
        resources:
          filter:
            NAME: '{{ program }}'
          get_parameters:
            - name: 'CSDGROUP'
              value: '{{ csdgroup }}'
      register: result

    - name: assert 7
      assert:
        that:
          - result is changed
          - result.cpsm_response == 'OK'
          - result.record_count == 1
          - result.success_count == 1


    - name: 'HTTP Delete progdef2'
      delegate_to: 'localhost'
      ibm.ibm_zos_cics.cmci_delete:
        type: 'CICSDefinitionProgram'
        resources:
          filter:
            NAME: '{{ program_2 }}'
          get_parameters:
            - name: 'CSDGROUP'
              value: '{{ csdgroup }}'
      register: result
    
    - name: assert program_2 deleted
      assert:
        that:
          - result is changed
          - result.cpsm_response == 'OK'
          - result.record_count == 1
          - result.success_count == 1


    - name: 'HTTP fail_on_nodata default'
      delegate_to: 'localhost'
      ibm.ibm_zos_cics.cmci_get:
        type: 'CICSDefinitionProgram'
        resources:
          filter:
            name: '{{ program_filter }}'
          get_parameters:
            - name: 'CSDGROUP'
              value: '{{ csdgroup }}'
      register: result
      failed_when: >
        'cpsm_response_code' not in result or result.cpsm_response_code not in [1024, 1027]
    
    - name: assert fail_on_nodata attribute default
      assert:
        that:
          - result is not changed
          - result.failed == false
          - result.cpsm_response == 'NODATA'
          - result.cpsm_response_code == 1027
          - result.record_count == 0
          - result.msg is defined
          - result.failed_when_result is defined


    - name: 'HTTP fail_on_nodata'
      delegate_to: 'localhost'
      ibm.ibm_zos_cics.cmci_get:
        type: 'CICSDefinitionProgram'
        fail_on_nodata: False
        resources:
          filter:
            name: '{{ program_filter }}'
          get_parameters:
            - name: 'CSDGROUP'
              value: '{{ csdgroup }}'
      register: result
    
    - name: assert fail_on_nodata attribute false
      assert:
        that:
          - result is not changed
          - result.failed == false
          - result.cpsm_response == 'NODATA'
          - result.cpsm_response_code == 1027
          - result.record_count == 0
          - result.msg is not defined
          - result.failed_when_result is not defined
